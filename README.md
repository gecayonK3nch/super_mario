# Super Mario (OOP Version)

## Описание проекта

Этот проект представляет собой реализацию классической игры Super Mario на языке C++ с использованием принципов объектно-ориентированного программирования (ООП).

**Ключевые особенности архитектуры:**
1.  **Разделение логики и представления:** Игровая логика полностью отделена от визуализации. Это позволяет легко менять графический интерфейс (например, с консольного на графический) без изменения кода самой игры.
2.  **Кроссплатформенность (абстракция от ОС):** Взаимодействие с операционной системой (ввод пользователя, системные настройки) вынесено в отдельный слой, что упрощает портирование на другие платформы.
3.  **Работа с абстракциями:** Логика игры оперирует абстрактными интерфейсами (`Movable`, `Collisionable`, `GameMap`), а не конкретными реализациями.

## Структура проекта

Проект организован в следующую структуру директорий:

*   `src/` - Исходный код проекта.
    *   `main.cpp` - Точка входа, содержит игровой цикл.
    *   `controller/` - Управление состоянием игры (`Game`).
    *   `model/` - Базовые классы и интерфейсы игровых объектов (`Mario`, `Enemy`, `Rect`, `Movable`).
    *   `levels/` - Реализация конкретных уровней игры.
    *   `ui/` - Система рендеринга.
        *   `console/` - Реализация консольного интерфейса.
    *   `os_controls/` - Абстракция ввода и системных вызовов.
        *   `windows/` - Реализация для Windows.
        *   `os_api/` - Общие интерфейсы.

## Архитектура

### 1. Игровой цикл (`main.cpp`)
Игровой цикл реализует классический паттерн:
1.  **Input:** Получение ввода от пользователя через `biv::os::get_user_input()`.
2.  **Update:** Обновление состояния игры (движение Марио, врагов, проверка коллизий) через методы класса `biv::Game`.
3.  **Render:** Обновление отображения (в данном случае, консольного вывода).

### 2. Контроллер (`src/controller`)
Класс `biv::Game` является центральным узлом логики. Он хранит списки всех объектов на сцене:
*   `map_movable_objs` - объекты, движущиеся вместе с картой.
*   `static_objs` - статические объекты.
*   `collisionable_objs` - объекты, участвующие в коллизиях.
*   `movable_objs` - подвижные объекты (с физикой).

Он отвечает за проверку столкновений (`check_static_collisions`, `check_mario_collision`) и перемещение объектов.

### 3. Модель (`src/model`)
Здесь определены основные сущности:
*   `Rect`: Базовый класс, описывающий прямоугольник (координаты, размеры).
*   `Movable`: Наследуется от `Rect`. Добавляет физику движения (скорость, ускорение, прыжки).
*   `Collisionable`: Интерфейс для объектов, которые могут сталкиваться.
*   `Mario`, `Enemy`: Конкретные игровые сущности.
*   `GameMap`: Абстрактный класс карты.

### 4. Представление (UI) (`src/ui`)
Используется паттерн **Abstract Factory**:
*   `UIFactory`: Абстрактная фабрика, объявляющая методы создания игровых объектов (`create_mario`, `create_enemy`, `create_box`).
*   `ConsoleUIFactory`: Конкретная реализация фабрики, создающая консольные версии объектов (`ConsoleMario`, `ConsoleEnemy`). Эти объекты знают, как отрисовать себя символами в консоли.

### 5. Уровни (`src/levels`)
Каждый уровень (например, `FirstLevel`) наследуется от `GameLevel`. Он использует `UIFactory` для инициализации карты и расстановки объектов (врагов, блоков) при старте уровня.

## Сборка и запуск

Для сборки проекта используется **CMake**.

### Требования
*   C++ компилятор с поддержкой C++17 или новее.
*   CMake.
*   Ninja (опционально, используется в скрипте сборки).

### Инструкция по сборке (Windows)

В корне проекта находится скрипт `build.bat`, который автоматизирует процесс сборки с использованием генератора Ninja.

1.  Запустите `build.bat`.
2.  Скрипт создаст папку `build_ninja`, сгенерирует файлы сборки и скомпилирует проект.
3.  Исполняемый файл появится в папке `build_ninja`.

Альтернативная ручная сборка:
```bash
mkdir build
cd build
cmake ../src
cmake --build .
```

## Управление

Управление осуществляется через клавиатуру (обработка в `src/os_controls/windows/user_input.cpp`).
*   **Стрелки влево/вправо:** Перемещение.
*   **Пробел:** Прыжок.
*   **Esc:** Выход (предположительно, зависит от реализации).

## Расширение проекта

### Добавление нового уровня
1.  Создайте новый класс, наследующийся от `biv::GameLevel` (например, `FourthLevel`).
2.  Реализуйте метод `init_data()`, используя `ui_factory` для создания объектов.
3.  В предыдущем уровне (например, `ThirdLevel`) в методе `get_next()` верните указатель на новый уровень.

### Добавление нового врага
1.  Создайте класс модели в `src/model` (наследуется от `Movable` и `Collisionable`).
2.  Добавьте метод создания в `UIFactory`.
3.  Реализуйте консольную версию в `src/ui/console` и в `ConsoleUIFactory`.

## API Reference

### `biv::Game`
Класс, управляющий состоянием игры и взаимодействием объектов.

| Метод | Входные параметры | Выходные параметры | Описание |
| :--- | :--- | :--- | :--- |
| `add_collisionable` | `Collisionable*` | `void` | Добавляет объект в список проверяемых на коллизии. |
| `add_map_movable` | `MapMovable*` | `void` | Добавляет объект, который движется вместе с картой. |
| `add_mario` | `Mario*` | `void` | Регистрирует объект Марио в игре. |
| `add_movable` | `Movable*` | `void` | Добавляет объект с физикой движения. |
| `add_static_obj` | `Rect*` | `void` | Добавляет статический объект (препятствие). |
| `check_static_collisions` | `Collisionable* obj` | `bool` | Проверяет столкновение объекта со статическими препятствиями. Возвращает `true`, если столкновение есть. |
| `check_mario_collision` | - | `void` | Проверяет столкновения Марио с другими объектами (врагами, монетами). |
| `move_map_left` | - | `void` | Сдвигает все объекты карты влево (имитация движения камеры вправо). |
| `move_map_right` | - | `void` | Сдвигает все объекты карты вправо. |
| `move_objs_horizontally` | - | `void` | Обновляет горизонтальное положение всех подвижных объектов. |
| `move_objs_vertically` | - | `void` | Обновляет вертикальное положение всех подвижных объектов (гравитация, прыжки). |

### `biv::Rect`
Базовый класс для всех прямоугольных объектов.

| Метод | Входные параметры | Выходные параметры | Описание |
| :--- | :--- | :--- | :--- |
| `get_top`, `get_bottom` | - | `int` | Возвращает координату Y верхней/нижней границы. |
| `get_left`, `get_right` | - | `int` | Возвращает координату X левой/правой границы. |
| `get_width`, `get_height` | - | `int` | Возвращает ширину/высоту объекта. |

### `biv::Movable`
Наследуется от `Rect`. Добавляет физику.

| Метод | Входные параметры | Выходные параметры | Описание |
| :--- | :--- | :--- | :--- |
| `jump` | - | `void` | Устанавливает вертикальную скорость для прыжка. |
| `move_horizontally` | - | `void` | Изменяет координату X на основе текущей скорости. |
| `move_vertically` | - | `void` | Изменяет координату Y на основе текущей скорости и гравитации. |
| `get_vspeed` | - | `float` | Возвращает текущую вертикальную скорость. |

### `biv::Collisionable`
Интерфейс для объектов, участвующих в коллизиях.

| Метод | Входные параметры | Выходные параметры | Описание |
| :--- | :--- | :--- | :--- |
| `has_collision` | `Rect*` | `bool` | Проверяет пересечение с другим прямоугольником. |
| `process_horizontal_static_collision` | `Rect*` | `void` | Обрабатывает столкновение со стеной по горизонтали. |
| `process_vertical_static_collision` | `Rect*` | `void` | Обрабатывает столкновение с полом/потолком. |
| `process_mario_collision` | `Collisionable*` | `void` | Обрабатывает столкновение с Марио (для врагов/бонусов). |

### `biv::UIFactory`
Абстрактная фабрика для создания игровых объектов.

| Метод | Входные параметры | Выходные параметры | Описание |
| :--- | :--- | :--- | :--- |
| `create_mario` | `Coord top_left`, `int width`, `int height` | `void` | Создает объект Марио. |
| `create_enemy` | `Coord top_left`, `int width`, `int height` | `void` | Создает врага. |
| `create_box` | `Coord top_left`, `int width`, `int height` | `void` | Создает разрушаемый блок. |
| `get_game_map` | - | `GameMap*` | Возвращает указатель на карту игры. |

### `biv::GameLevel`
Базовый класс уровня.

| Метод | Входные параметры | Выходные параметры | Описание |
| :--- | :--- | :--- | :--- |
| `get_next` | - | `GameLevel*` | Возвращает указатель на следующий уровень. |
| `init_data` | - | `void` | Инициализирует объекты уровня через `UIFactory`. |
| `is_final` | - | `bool` | Возвращает `true`, если это последний уровень. |

### `biv::os`
Пространство имен для системных функций.

| Функция | Входные параметры | Выходные параметры | Описание |
| :--- | :--- | :--- | :--- |
| `get_user_input` | - | `UserInput` | Опрашивает клавиатуру и возвращает код действия (`MAP_LEFT`, `MARIO_JUMP` и т.д.). |

